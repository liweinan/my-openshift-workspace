#!/bin/bash

# test-metadata-generator.sh
# Test metadata.json generator

set -o nounset
set -o errexit
set -o pipefail

# æµ‹è¯•å‚æ•°
TEST_CLUSTER_NAME="test-cluster"
TEST_REGION="us-east-1"
TEST_INFRA_ID="test-cluster-abc123"
TEST_CLUSTER_ID="12345678-1234-1234-1234-123456789012"
TEST_OUTPUT_DIR="./test-cleanup"

echo "ğŸ§ª Testing metadata.json generator..."
echo

# æ¸…ç†ä¹‹å‰çš„æµ‹è¯•æ–‡ä»¶
rm -rf "$TEST_OUTPUT_DIR"

echo "ğŸ“‹ Test parameters:"
echo "  Cluster name: $TEST_CLUSTER_NAME"
echo "  AWS region: $TEST_REGION"
echo "  Infrastructure ID: $TEST_INFRA_ID"
echo "  Cluster ID: $TEST_CLUSTER_ID"
echo "  Output directory: $TEST_OUTPUT_DIR"
echo

# Test full-featured version
echo "ğŸ”§ Testing full-featured version..."
if ./generate-metadata-for-destroy.sh \
  -c "$TEST_CLUSTER_NAME" \
  -r "$TEST_REGION" \
  -i "$TEST_INFRA_ID" \
  -u "$TEST_CLUSTER_ID" \
  -o "$TEST_OUTPUT_DIR"; then
    echo "âœ… Full-featured version test passed"
else
    echo "âŒ Full-featured version test failed"
    exit 1
fi

echo

# Validate generated files
echo "ğŸ” Validating generated files..."
if [[ -f "$TEST_OUTPUT_DIR/metadata.json" ]]; then
    echo "âœ… metadata.json file exists"
    
    # éªŒè¯ JSON æ ¼å¼
    if jq empty "$TEST_OUTPUT_DIR/metadata.json" 2>/dev/null; then
        echo "âœ… JSON format is valid"
    else
        echo "âŒ JSON format is invalid"
        exit 1
    fi
    
    # éªŒè¯å¿…éœ€å­—æ®µ
    local required_fields=("clusterName" "clusterID" "infraID" "aws.region" "aws.identifier")
    local all_fields_valid=true
    
    for field in "${required_fields[@]}"; do
        if jq -e ".$field" "$TEST_OUTPUT_DIR/metadata.json" > /dev/null 2>&1; then
            echo "âœ… Field '$field' exists"
        else
            echo "âŒ Field '$field' is missing"
            all_fields_valid=false
        fi
    done
    
    if [[ "$all_fields_valid" == true ]]; then
        echo "âœ… All required fields are present"
    else
        echo "âŒ Some required fields are missing"
        exit 1
    fi
    
    # æ˜¾ç¤ºç”Ÿæˆçš„å†…å®¹
    echo
    echo "ğŸ“„ Generated metadata.json content:"
    cat "$TEST_OUTPUT_DIR/metadata.json" | jq .
    
else
    echo "âŒ metadata.json file does not exist"
    exit 1
fi

echo

# Clean up test files
rm -rf "$TEST_OUTPUT_DIR"

# Test simplified version
echo "ğŸ”§ Testing simplified version..."
if ./quick-generate-metadata.sh "$TEST_CLUSTER_NAME" "$TEST_REGION" "$TEST_INFRA_ID" "$TEST_CLUSTER_ID" "$TEST_OUTPUT_DIR"; then
    echo "âœ… Simplified version test passed"
else
    echo "âŒ Simplified version test failed"
    exit 1
fi

echo

# Validate files generated by simplified version
echo "ğŸ” Validating files generated by simplified version..."
if [[ -f "$TEST_OUTPUT_DIR/metadata.json" ]]; then
    echo "âœ… metadata.json file exists"
    
    # éªŒè¯ JSON æ ¼å¼
    if jq empty "$TEST_OUTPUT_DIR/metadata.json" 2>/dev/null; then
        echo "âœ… JSON format is valid"
    else
        echo "âŒ JSON format is invalid"
        exit 1
    fi
    
    # æ˜¾ç¤ºç”Ÿæˆçš„å†…å®¹
    echo
    echo "ğŸ“„ Generated metadata.json content:"
    cat "$TEST_OUTPUT_DIR/metadata.json" | jq .
    
else
    echo "âŒ metadata.json file does not exist"
    exit 1
fi

echo

# æ¸…ç†æµ‹è¯•æ–‡ä»¶
rm -rf "$TEST_OUTPUT_DIR"

echo "ğŸ‰ All tests passed!"
echo
echo "ğŸ“‹ Usage examples:"
echo "  # Full-featured version"
echo "  ./generate-metadata-for-destroy.sh -c \"my-cluster\" -r \"us-east-1\" -i \"my-cluster-abc123\" -u \"12345678-1234-1234-1234-123456789012\""
echo
echo "  # Simplified version"
echo "  ./quick-generate-metadata.sh \"my-cluster\" \"us-east-1\" \"my-cluster-abc123\" \"12345678-1234-1234-1234-123456789012\""
echo
echo "  # Destroy cluster"
echo "  cd cleanup"
echo "  openshift-install destroy cluster --dir . --log-level debug"
